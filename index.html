<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pandora AydÄ±nlatma | Barkod Tarama</title>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        /* Stil kÄ±smÄ± aynÄ± kalabilir */
    </style>
</head>
<body>
    <div class="container">
        <h2>ğŸ“¸ Pandora Barkod Tarama</h2>
        <button id="start-btn" class="btn-start">ğŸ“· TaramayÄ± BaÅŸlat</button>
        <button id="stop-btn" class="btn-stop">â¹ TaramayÄ± Durdur</button>
        <button id="reset-btn" class="btn-reset">ğŸ”„ SÄ±fÄ±rla</button>
        <div id="scanner"></div>
        <p id="result">Tarama Sonucu: <span id="barcode"></span></p>
        <div class="product-container">
            <div id="product-image"><img id="barcode-image" src="" alt="ÃœrÃ¼n Resmi"></div>
            <p id="product-info"></p>
        </div>
    </div>

    <script>
        let scanner;
        let scanning = false;

        // Kamera baÅŸlatma
        document.getElementById("start-btn").addEventListener("click", async function() {
            if (!scanning) {
                try {
                    if (typeof Html5Qrcode === "undefined") {
                        alert("Html5Qrcode kÃ¼tÃ¼phanesi yÃ¼klenemedi. Ä°nternet baÄŸlantÄ±nÄ±zÄ± kontrol edin.");
                        return;
                    }

                    scanner = new Html5Qrcode("scanner");
                    const devices = await Html5Qrcode.getCameras();
                    if (devices && devices.length > 0) {
                        scanner.start(
                            { facingMode: "environment" }, // Arka kamera Ã¶ncelikli
                            { fps: 10, qrbox: { width: 250, height: 250 } },
                            onScanSuccess,
                            onScanError
                        );
                        scanning = true;
                        document.getElementById("scanner").style.display = "block";
                        document.getElementById("start-btn").style.display = "none";
                        document.getElementById("stop-btn").style.display = "inline-block";
                        document.getElementById("reset-btn").style.display = "inline-block";
                    } else {
                        alert("Cihazda kamera bulunamadÄ±!");
                    }
                } catch (err) {
                    console.error("Kamera baÅŸlatma hatasÄ±:", err);
                    alert("Kamera baÅŸlatÄ±lamadÄ±. Ä°zin verdiÄŸinizden ve HTTPS Ã¼zerinden Ã§alÄ±ÅŸtÄ±ÄŸÄ±ndan emin olun.");
                }
            }
        });

        // Kamera durdurma
        document.getElementById("stop-btn").addEventListener("click", function() {
            if (scanning && scanner) {
                scanner.stop().then(() => {
                    scanning = false;
                    document.getElementById("scanner").style.display = "none";
                    document.getElementById("start-btn").style.display = "inline-block";
                    document.getElementById("stop-btn").style.display = "none";
                }).catch(err => console.error("Durdurma baÅŸarÄ±sÄ±z:", err));
            }
        });

        // SÄ±fÄ±rlama
        document.getElementById("reset-btn").addEventListener("click", function() {
            document.getElementById("barcode").innerText = "";
            document.getElementById("product-info").innerText = "";
            document.getElementById("barcode-image").style.display = "none";
            document.getElementById("reset-btn").style.display = "none";
        });

        // Tarama baÅŸarÄ±lÄ± olduÄŸunda
        function onScanSuccess(decodedText, decodedResult) {
            document.getElementById("barcode").innerText = decodedText;
            fetchProductDetails(decodedText);
            document.getElementById("reset-btn").style.display = "inline-block";
        }

        // Tarama hatasÄ± olduÄŸunda
        function onScanError(errorMessage) {
            console.warn("Tarama hatasÄ±:", errorMessage);
            // KullanÄ±cÄ±ya bilgi verebiliriz
            // document.getElementById("result").innerText = "Tarama hatasÄ±: " + errorMessage;
        }

        // ÃœrÃ¼n bilgisi Ã§ekme
        function fetchProductDetails(barcode) {
            fetch("product.csv")
                .then(response => {
                    if (!response.ok) throw new Error("CSV dosyasÄ± yÃ¼klenemedi!");
                    return response.text();
                })
                .then(data => {
                    let rows = data.split("\n");
                    for (let i = 1; i < rows.length; i++) {
                        let cols = rows[i].split(";");
                        if (cols[0].trim() === barcode.trim()) {
                            document.getElementById("product-info").innerHTML = `
                                ğŸ“¦ <strong>ÃœrÃ¼n:</strong> ${cols[1]} <br>
                                ğŸ“ <strong>Ã–lÃ§Ã¼:</strong> ${cols[2]} <br>
                                ğŸ’¡ <strong>AmpÃ¼l:</strong> ${cols[4]} <br>
                                ğŸ’° <strong>dip.fiyat:</strong> ${cols[6]}â‚º <br>
                                ğŸ’° <strong>Fiyat:</strong> ${cols[7]}â‚º <br>
                            `;
                            let imageUrl = `${barcode}.jpg`;
                            document.getElementById("barcode-image").src = imageUrl;
                            document.getElementById("barcode-image").style.display = "block";
                            return;
                        }
                    }
                    document.getElementById("product-info").innerText = "âš  ÃœrÃ¼n bulunamadÄ±!";
                    document.getElementById("barcode-image").style.display = "none";
                })
                .catch(error => {
                    console.error("CSV yÃ¼kleme hatasÄ±:", error);
                    document.getElementById("product-info").innerText = "âš  ÃœrÃ¼n bilgileri yÃ¼klenemedi!";
                });
        }
    </script>
</body>
</html>
